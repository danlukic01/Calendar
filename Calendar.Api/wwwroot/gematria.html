<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gematria Calculator</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
            background: #f5f7fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
            color: #333;
        }
        nav.main-nav {
            margin-bottom: 20px;
        }
        nav.main-nav a {
            margin: 0 10px;
            color: #333;
            text-decoration: none;
            font-weight: bold;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px 30px;
            max-width: 600px;
            width: 90%;
            margin-bottom:20px;
        }
        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            text-align: center;
        }
        input, select, button {
            width: 100%;
            padding: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        #result {
            font-weight: bold;
            margin-top: 10px;
        }
        .result-phrase {
            margin:4px 0;
        }
        .calendar-section {
            background:#fff;
            border-radius:8px;
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
            padding:10px 15px;
            margin-bottom:20px;
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <a href="index.html">Predict</a>
        <a href="lotto-entry.html">Enter Numbers</a>
        <a href="gematria.html">Gematria</a>
    </nav>
    <div class="card">
        <h1>Gematria Calculator</h1>
        <input type="text" id="text-input" placeholder="Enter text">
        <div id="result"></div>
    </div>

    <div class="card">
        <h1>AFL Gematria Match Predictor</h1>
        <select id="team-a"></select>
        <select id="team-b"></select>
        <input type="date" id="date-picker">
        <div id="date-info" style="font-size:0.9rem;margin-bottom:10px;"></div>
        <button id="predict-btn">Predict Winner</button>
        <div id="prediction" style="font-weight:bold;margin-bottom:10px;"></div>
        <div id="calendar-results"></div>
        <div id="round-results"></div>
    </div>

<script>
function gematriaValue(str) {
    return str.toUpperCase().split('').reduce((sum, ch) => {
        const code = ch.charCodeAt(0);
        if (code >= 65 && code <= 90) {
            return sum + (code - 64);
        }
        if (code >= 48 && code <= 57) {
            return sum + (code - 48);
        }
        return sum;
    }, 0);
}

function digitalRoot(num) {
    while (num > 9) {
        num = num.toString().split('').reduce((s,d)=>s+parseInt(d,10),0);
    }
    return num;
}

const teams = [
    "Adelaide Crows",
    "Brisbane Lions",
    "Carlton Blues",
    "Collingwood Magpies",
    "Essendon Bombers",
    "Fremantle Dockers",
    "Geelong Cats",
    "Gold Coast Suns",
    "Greater Western Sydney Giants",
    "Hawthorn Hawks",
    "Melbourne Demons",
    "North Melbourne Kangaroos",
    "Port Adelaide Power",
    "Richmond Tigers",
    "St Kilda Saints",
    "Sydney Swans",
    "West Coast Eagles",
    "Western Bulldogs"
];

const teamSelectA = document.getElementById('team-a');
const teamSelectB = document.getElementById('team-b');
let currentDates = null;

teams.forEach(t => {
    const optA = document.createElement('option');
    optA.value = t;
    optA.textContent = t;
    teamSelectA.appendChild(optA);
    const optB = document.createElement('option');
    optB.value = t;
    optB.textContent = t;
    teamSelectB.appendChild(optB);
});

const datePicker = document.getElementById('date-picker');
const dateInfoDiv = document.getElementById('date-info');

function formatGregorian(dateStr) {
    const g = new Date(dateStr + 'Z');
    return `${g.getUTCDate().toString().padStart(2,'0')}/${(g.getUTCMonth()+1).toString().padStart(2,'0')}/${g.getUTCFullYear()}`;
}

function loadDate(dateString) {
    fetch(`/api/date/convert?date=${dateString}`)
        .then(r => r.json())
        .then(d => {
            currentDates = d;
            const g = formatGregorian(d.gregorianDate);
            dateInfoDiv.innerHTML = `Gregorian: ${g}`;
        });
}

datePicker.addEventListener('change', () => loadDate(datePicker.value));

const todayStr = new Date().toISOString().split('T')[0];
datePicker.value = todayStr;
loadDate(todayStr);

function createPhrases(team, calendar, date) {
    return [
        `${team} win the game on ${calendar} date ${date}`,
        `${team} wins the game on ${calendar} date ${date}`,
        `${team} won the game on ${calendar} date ${date}`,
        `${team} lose the game on ${calendar} date ${date}`,
        `${team} loses the game on ${calendar} date ${date}`,
        `${team} lost the game on ${calendar} date ${date}`
    ];
}

function classify(root) {
    const diffYes = Math.abs(root - 4);
    const diffNo = Math.abs(root - 2);
    if (diffYes <= diffNo) {
        if (diffYes === 0) return { color: '#008000' };
        if (diffYes === 1) return { color: '#4caf50' };
        if (diffYes === 2) return { color: '#9ccc65' };
        return { color: '#ccc' };
    } else {
        if (diffNo === 0) return { color: '#ff0000' };
        if (diffNo === 1) return { color: '#ff5555' };
        if (diffNo === 2) return { color: '#ff9999' };
        return { color: '#ccc' };
    }
}

function analyzePhrases(team, calendar, date) {
    const phrases = createPhrases(team, calendar, date);
    return phrases.map((p, idx) => {
        const val = gematriaValue(p);
        const root = digitalRoot(val);
        const category = idx < 3 ? 'win' : 'lose';
        return { phrase: p, root: root, category: category, color: classify(root).color };
    });
}

function displayTeamResults(team, data, container) {
    container.innerHTML = `<h3>${team}</h3>`;
    data.forEach(r => {
        const div = document.createElement('div');
        div.className = 'result-phrase';
        div.textContent = `${r.phrase} (${r.root})`;
        div.style.color = r.color;
        container.appendChild(div);
    });
}

function analyzeCalendars(team, dates) {
    const calStrings = {
        'Gregorian': formatGregorian(dates.gregorianDate)
    };
    const out = {};
    for (const [name, val] of Object.entries(calStrings)) {
        out[name] = analyzePhrases(team, name, val);
    }
    return out;
}

function phraseScore(item) {
    if (item.category === 'win') {
        if (item.root === 4) return 1;
        if (item.root === 2) return -1;
    } else if (item.category === 'lose') {
        if (item.root === 4) return -1;
        if (item.root === 2) return 1;
    }
    return 0;
}

function computePoints(dataA, dataB) {
    let pointsA = 0, pointsB = 0;
    dataA.forEach(p => { pointsA += phraseScore(p); });
    dataB.forEach(p => { pointsB += phraseScore(p); });
    return { pointsA, pointsB };
}

function buildCalendarSection(name, teamA, teamB, dataA, dataB) {
    const { pointsA, pointsB } = computePoints(dataA, dataB);
    const sec = document.createElement('div');
    sec.className = 'calendar-section';
    const heading = document.createElement('h3');
    let predicted;
    if (pointsA > pointsB) predicted = teamA;
    else if (pointsB > pointsA) predicted = teamB;
    else predicted = 'Draw';
    heading.textContent = `${name} - Predicted Winner: ${predicted}`;
    sec.appendChild(heading);

    const teamDivA = document.createElement('div');
    displayTeamResults(teamA, dataA, teamDivA);
    sec.appendChild(teamDivA);

    const teamDivB = document.createElement('div');
    displayTeamResults(teamB, dataB, teamDivB);
    sec.appendChild(teamDivB);

    const scoreInfo = document.createElement('div');
    scoreInfo.textContent = `${teamA} Points: ${pointsA} | ${teamB} Points: ${pointsB}`;
    sec.appendChild(scoreInfo);

    return { section: sec, pointsA, pointsB };
}

async function fetchCurrentRoundGames() {
    const year = new Date().getUTCFullYear();
    const apiUrl = `https://api.squiggle.com.au/?q=games;year=${year};next=1`;
    try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('api');
        const data = await res.json();
        if (data.games && data.games.length > 0) {
            const upcomingRound = Math.min(...data.games.map(g => g.round));
            return data.games.filter(g => g.round === upcomingRound).map(g => ({
                teamA: g.hteam || g.homeTeam,
                teamB: g.ateam || g.awayTeam,
                date: g.date.substring(0,10)
            }));
        }
    } catch (e) {
        const res = await fetch('data/round.json');
        const data = await res.json();
        return data.games;
    }
    return [];
}

async function predictCurrentRound() {
    const games = await fetchCurrentRoundGames();
    const roundDiv = document.getElementById('round-results');
    roundDiv.innerHTML = '';
    for (const g of games) {
        const dates = { gregorianDate: g.date };
        const dataA = analyzeCalendars(g.teamA, dates);
        const dataB = analyzeCalendars(g.teamB, dates);
        const { section } = buildCalendarSection('Gregorian', g.teamA, g.teamB, dataA['Gregorian'], dataB['Gregorian']);
        const wrapper = document.createElement('div');
        const head = document.createElement('h2');
        head.textContent = `${g.teamA} vs ${g.teamB} - ${formatGregorian(g.date)}`;
        wrapper.appendChild(head);
        wrapper.appendChild(section);
        roundDiv.appendChild(wrapper);
    }
}


function predict() {
    const teamA = teamSelectA.value;
    const teamB = teamSelectB.value;
    if (!teamA || !teamB || !currentDates) return;

    const dataA = analyzeCalendars(teamA, currentDates);
    const dataB = analyzeCalendars(teamB, currentDates);

    const container = document.getElementById('calendar-results');
    container.innerHTML = '';

    let totalA = 0;
    let totalB = 0;
    Object.keys(dataA).forEach(cal => {
        const { section, pointsA, pointsB } = buildCalendarSection(cal, teamA, teamB, dataA[cal], dataB[cal]);
        totalA += pointsA;
        totalB += pointsB;
        container.appendChild(section);
    });

    const summarySec = document.createElement('div');
    summarySec.className = 'calendar-section';
    const heading = document.createElement('h3');
    let overallWinner;
    if (totalA > totalB) overallWinner = teamA;
    else if (totalB > totalA) overallWinner = teamB;
    else overallWinner = 'Draw';
    heading.textContent = `Overall Predicted Winner: ${overallWinner}`;
    summarySec.appendChild(heading);
    const pointsInfo = document.createElement('div');
    pointsInfo.textContent = `${teamA} Total Points: ${totalA} | ${teamB} Total Points: ${totalB}`;
    summarySec.appendChild(pointsInfo);
    container.appendChild(summarySec);

    document.getElementById('prediction').textContent = overallWinner;

    predictCurrentRound();
}

document.getElementById('predict-btn').addEventListener('click', predict);

document.getElementById('text-input').addEventListener('input', function() {
    const value = gematriaValue(this.value);
    document.getElementById('result').textContent = 'Value: ' + value;
});
</script>
</body>
</html>
